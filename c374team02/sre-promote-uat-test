pipeline {
  agent {
    kubernetes {
        yaml """\
    apiVersion: v1
    kind: Pod
    metadata:
      labels:
        builder: promotion
    spec:
      serviceAccountName: jenkins-agent
      containers:
      - name: awscli
        image: amazon/aws-cli
        command:
        - cat
        tty: true
    """.stripIndent()
    }
  }
  stages {
    stage('Promote to UAT') {
      steps {
          container(name: 'awscli') {
            script {
              buildNumber = Jenkins.instance.getItem(projectName).lastSuccessfulBuild.number
            }
            sh '''
            dev_api_tags=$(aws ecr list-images --repository-name production-support-course | dev_tags=$(grep "c374team02" | grep "dev" | sort | tail -n 1))
            dev_currapi_tags=$(aws ecr list-images --repository-name production-support-course | dev_tags=$(grep "c374team02currency-api" | grep "dev" | sort | tail -n 1))
            dev_fe_tags=$(aws ecr list-images --repository-name production-support-course | dev_tags=$(grep "c374team02fe" | grep "dev" | sort | tail -n 1))
            dev_db_tags=$(aws ecr list-images --repository-name production-support-course | dev_tags=$(grep "c374team02db" | grep "dev" | sort | tail -n 1))
            uat_api_tags=$(aws ecr list-images --repository-name production-support-course | dev_tags=$(grep "c374team02" | grep "dev" | sort | tail -n 1))
            uat_currapi_tags=$(aws ecr list-images --repository-name production-support-course | dev_tags=$(grep "c374team02currency-api" | grep "dev" | sort | tail -n 1))
            uat_fe_tags=$(aws ecr list-images --repository-name production-support-course | dev_tags=$(grep "c374team02fe" | grep "dev" | sort | tail -n 1))
            uat_db_tags=$(aws ecr list-images --repository-name production-support-course | dev_tags=$(grep "c374team02db" | grep "dev" | sort | tail -n 1))
            prod_api_tags=$(aws ecr list-images --repository-name production-support-course | dev_tags=$(grep "c374team02" | grep "dev" | sort | tail -n 1))
            prod_currapi_tags=$(aws ecr list-images --repository-name production-support-course | dev_tags=$(grep "c374team02currency-api" | grep "dev" | sort | tail -n 1))
            prod_fe_tags=$(aws ecr list-images --repository-name production-support-course | dev_tags=$(grep "c374team02fe" | grep "dev" | sort | tail -n 1))
            prod_db_tags=$(aws ecr list-images --repository-name production-support-course | dev_tags=$(grep "c374team02db" | grep "dev" | sort | tail -n 1))
            echo "$dev_tags"$'\n'"$uat_tags"$'\n'"$prod_tags"
'''
        }
      }
    }
  }
  environment {
    ECR_REPO = '108174090253.dkr.ecr.us-east-1.amazonaws.com/production-support-course'

    imageAPIDevName='c374team02api-dev-'
    imageAPIUATName='c374team02api-uat-'
    imageDBDevName='c374team02db-dev-'
    imageDBUATName='c374team02db-uat-'
    imageFEDevName='c374team02fe-dev-'
    imageFEUATName='c374team02fe-uat-'
    projectName='c374team02'

  }
}
